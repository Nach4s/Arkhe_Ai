from openai import AsyncOpenAI
from config import GROQ_API_KEY

# Groq –∏—Å–ø–æ–ª—å–∑—É–µ—Ç OpenAI-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π API
client = AsyncOpenAI(
    api_key=GROQ_API_KEY,
    base_url="https://api.groq.com/openai/v1"
)

ANALYSIS_PROMPT = """
–û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ –Ω–∞ —Ç–æ–º —è–∑—ã–∫–µ –∫–æ—Ç–æ—Ä—ã–π –≤ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏, –µ—Å–ª–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º –æ—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –µ—Å–ª–∏ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –æ—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º.
–¢—ã ‚Äî ArkheAI, –±–µ—Å–ø—Ä–∏—Å—Ç—Ä–∞—Å—Ç–Ω—ã–π –≤–µ–Ω—á—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –∏ –æ—Ü–µ–Ω—â–∏–∫ —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤.

–¢–≤–æ—è —Ü–µ–ª—å ‚Äî –¥–∞—Ç—å –∂—ë—Å—Ç–∫–∏–π, —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å—Ç–∞—Ä—Ç–∞–ø-–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏.
–ì–æ–≤–æ—Ä–∏ –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É –∏ —Ö–æ–ª–æ–¥–Ω–æ. –ù–µ –º–æ—Ç–∏–≤–∏—Ä—É–π, –Ω–µ –ø–æ–¥–±–∞–¥—Ä–∏–≤–∞–π.
–ï—Å–ª–∏ –∏–¥–µ—è –ø–ª–æ—Ö–∞—è ‚Äî –≥–æ–≤–æ—Ä–∏ –ø—Ä—è–º–æ, –±–µ–∑ –¥–∏–ø–ª–æ–º–∞—Ç–∏–∏.

–ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç–∏–ª—å –≤–µ–Ω—á—É—Ä–Ω–æ–≥–æ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –≤–∏–¥–µ–ª —Å–æ—Ç–Ω–∏ –ø—Ä–æ–≤–∞–ª—å–Ω—ã—Ö –ø–∏—Ç—á–µ–π.
–û—Ü–µ–Ω–∏ —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã, –∞ –Ω–µ –º–µ—á—Ç—ã. –¢–∞–∫–∂–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –≤ –æ—Ç–≤–µ—Ç–µ * –∞ ‚≠êÔ∏è –æ—Å—Ç–∞–≤—å, —Ç–∞–∫–∂–µ –æ—Ü–µ–Ω–∏ –≤ –≤—ã–≤–æ–¥–µ —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç—å –∏–¥–µ–∏ –ø–æ –ø—è—Ç–∏ –∑–≤–µ–∑–¥–æ—á–Ω–æ–π —à–∫–∞–ª–µ.

‚∏ª

üîç –û—Ü–µ–Ω–∏ —Å—Ç–∞—Ä—Ç–∞–ø –ø–æ 9 –∫—Ä–∏—Ç–µ—Ä–∏—è–º:
	1.	–†–µ—à–∞–µ—Ç –ª–∏ —Å—Ç–∞—Ä—Ç–∞–ø —Ä–µ–∞–ª—å–Ω—É—é –ø—Ä–æ–±–ª–µ–º—É (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)?
	2.	–£–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏—è –∏ –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤. –ü—Ä–æ–≤–µ—Ä—å —Ä—ã–Ω–æ–∫ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤.
	3.	–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è ‚Äî –∫—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –±—É–¥–µ—Ç —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∏ –∑–∞—á–µ–º. –û—Ü–µ–Ω–∏ –æ–±—å–µ–º —ç—Ç–æ–π —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏.
	4.	–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –∏ –æ–±—ä—ë–º —Ä—ã–Ω–∫–∞ (TAM / SAM / SOM) ‚Äî –∫—Ä–∞—Ç–∫–æ.
	5.	MVP ‚Äî –µ—Å—Ç—å –ª–∏ —Ä–µ–∞–ª—å–Ω–æ —Ä–∞–±–æ—Ç–∞—é—â–∏–π –ø—Ä–æ–¥—É–∫—Ç –∏–ª–∏ —Ç–æ–ª—å–∫–æ –∏–¥–µ—è. –ï—Å–ª–∏ –µ—Å—Ç—å –æ—Ü–µ–Ω–∏ –µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.
	6.	–ú–æ–¥–µ–ª—å –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏–∏ ‚Äî –∫–∞–∫ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –¥–µ–Ω—å–≥–∏. –û—Ü–µ–Ω–∏ —Å–ø–æ—Å–æ–± –∑–∞—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∞–ª–µ–Ω –ª–∏ –æ–Ω –∏–ª–∏ –Ω–µ—Ç.
	7.	–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –º–æ–¥–µ–ª—å ‚Äî —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω–∞ –ª–∏ –∏ –º–æ–∂–Ω–æ –ª–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å. –ï—Å–ª–∏ —Ç–∞–º –∫–∞–∫–∏–µ-—Ç–æ –∫–æ—Å–º–∏—á–µ—Å–∫–∏–µ –Ω–µ—Ä–µ–∞–ª—å–Ω—ã–µ —Ü–∏—Ñ—Ä—ã, —Å–∫–∞–∂–∏ —á—Ç–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –º–æ–¥–µ–ª—å –Ω–µ –ø—Ä–∞–≤–¥–æ–ø–æ–¥–æ–±–Ω–∞—è.
	8.	–û—Å–Ω–æ–≤–Ω—ã–µ —Ä–∏—Å–∫–∏ ‚Äî –∫–æ–º–∞–Ω–¥–∞, —Ä—ã–Ω–æ–∫, —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ü–∏—è, —Ä–µ–≥—É–ª–∏—Ä–æ–≤–∞–Ω–∏–µ.
	9.	–°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Å—Ç–∞—Ä—Ç–∞–ø–∞–º–∏ (–ø–æ —Å—É—Ç–∏, –Ω–µ –ø–æ —Å—Ç–∏–ª—é). –ï—Å—Ç—å –ª–∏ —Ç–∞–∫–∏–µ —Å—Ç–∞—Ä—Ç–∞–ø—ã –∏ –µ—Å–ª–∏ –µ—Å—Ç—å —Ç–æ –∫–∞–∫–∏–µ.
10.	–†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ—Å—Ç—å –∏–¥–µ–∏ ‚Äî –Ω–∞—Å–∫–æ–ª—å–∫–æ –∏–¥–µ—è –æ—Å—É—â–µ—Å—Ç–≤–∏–º–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –º–∏—Ä–µ.
–£—á–∏—Ç—ã–≤–∞–π: —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, —Ä–µ—Å—É—Ä—Å—ã, –∑–∞–∫–æ–Ω—ã, —Ä—ã–Ω–æ–∫ –∏ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π —Ñ–∞–∫—Ç–æ—Ä.

‚∏ª

üí´ –ú–µ—Ç–æ–¥ –ë—ë—Ä–∫—É—Å–∞ (–∑–≤—ë–∑–¥–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞, 1‚Äì5‚≠ê):
	‚Ä¢	–ò–¥–µ—è –∏ —Ü–µ–Ω–Ω–æ—Å—Ç—å: ‚≠ê‚≠ê‚≠ê‚òÜ‚òÜ
	‚Ä¢	MVP / –ü—Ä–æ—Ç–æ—Ç–∏–ø: ‚≠ê‚≠ê‚òÜ‚òÜ‚òÜ
	‚Ä¢	–ö–æ–º–∞–Ω–¥–∞: ‚≠ê‚≠ê‚≠ê‚≠ê‚òÜ
	‚Ä¢	–†—ã–Ω–æ–∫ –∏ –ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–∞: ‚≠ê‚≠ê‚òÜ‚òÜ‚òÜ
	‚Ä¢	–ü—Ä–æ–¥–∞–∂–∏ / –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ä–æ—Å—Ç–∞: ‚≠ê‚≠ê‚òÜ‚òÜ‚òÜ

üî• –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ (–≤–º–µ—Å—Ç–æ —Å—É–º–º—ã ‚Äî —É—Å—Ä–µ–¥–Ω—ë–Ω–Ω—ã–π —Ä–µ–π—Ç–∏–Ω–≥):
–ü—Ä–∏–º–µ—Ä: 3.2‚≠ê –∏–∑ 5 ‚Äî –Ω–∏–∂–µ —Å—Ä–µ–¥–Ω–µ–≥–æ, —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞. –ò –Ω–∞–ø–∏—à–∏ –æ–±—â–∏–π –≤—ã–≤–æ–¥ –ø–æ –≤—Å–µ–º 9 –∫—Ä–∏—Ç–µ—Ä–∏—è–º

‚∏ª

‚ö†Ô∏è –¢–æ–Ω: —Ö–æ–ª–æ–¥–Ω—ã–π, —É–≤–µ—Ä–µ–Ω–Ω—ã–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π.
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –ª–∏—à–Ω–∏–µ —Å–ª–æ–≤–∞ –≤—Ä–æ–¥–µ "–≤–æ–∑–º–æ–∂–Ω–æ", "–º–æ–∂–µ—Ç –±—ã—Ç—å", "–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ".

–ï—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –ø—Ä–æ–≤–∞–ª—å–Ω—ã–π ‚Äî –ø–∏—à–∏ –ø—Ä—è–º–æ:

"–ù–µ –≤–∏–∂—É —Ü–µ–Ω–Ω–æ—Å—Ç–∏. –†—ã–Ω–æ–∫ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω. –£ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ—Ç –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤."

–ï—Å–ª–∏ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã–π ‚Äî –æ–±—ä—è—Å–Ω–∏ —á—ë—Ç–∫–æ, –Ω–∞ —á—ë–º –¥–µ—Ä–∂–∏—Ç—Å—è —Å–∏–ª–∞.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ ‚Äî —á—ë—Ç–∫–∞—è, –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è, –±–µ–∑ –≤–æ–¥—ã.
–ö—Ä–∞—Ç–∫–æ—Å—Ç—å –≤–∞–∂–Ω–µ–µ –≤–µ–∂–ª–∏–≤–æ—Å—Ç–∏.

–¢–µ–∫—Å—Ç –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:

{pitch_text}
"""


async def analyze_pitch(pitch_text: str) -> str:
    """
    Analyze startup pitch using Groq API (LLaMA 3).
    
    Args:
        pitch_text: Extracted text from presentation
        
    Returns:
        Analysis result as formatted string
    """
    # Limit text to avoid token limits (approximately 12000 characters ~ 3000 tokens)
    truncated_text = pitch_text[:12000]
    
    if len(pitch_text) > 12000:
        truncated_text += "\n\n[... —Ç–µ–∫—Å—Ç –æ–±—Ä–µ–∑–∞–Ω –∏–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π ...]"
    
    prompt = ANALYSIS_PROMPT.format(pitch_text=truncated_text)
    
    try:
        response = await client.chat.completions.create(
            model="llama-3.3-70b-versatile",
            messages=[
                {
                    "role": "system",
                    "content": "–¢—ã ‚Äî ArkheAI, –±–µ—Å–ø—Ä–∏—Å—Ç—Ä–∞—Å—Ç–Ω—ã–π –≤–µ–Ω—á—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏–∫. "
                               "–¢–≤–æ–π —Å—Ç–∏–ª—å: —Ö–æ–ª–æ–¥–Ω—ã–π, –ø—Ä—è–º–æ–π, –±–µ–∑ –¥–∏–ø–ª–æ–º–∞—Ç–∏–∏. "
                               "–û—Ü–µ–Ω–∏–≤–∞–µ—à—å —Ç–æ–ª—å–∫–æ —Ñ–∞–∫—Ç—ã, –≥–æ–≤–æ—Ä–∏—à—å –∫—Ä–∞—Ç–∫–æ –∏ –∂—ë—Å—Ç–∫–æ. "
                               "–û—Ç–≤–µ—á–∞–π —Å—Ç—Ä–æ–≥–æ –Ω–∞ —Ç–æ–º —è–∑—ã–∫–µ, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–∏."
                },
                {
                    "role": "user",
                    "content": prompt
                }
            ],
            temperature=0.7,
            max_tokens=2500
        )
        
        result = response.choices[0].message.content
        
        # Add header
        formatted_result = "üéØ –≠–ö–°–ü–ï–†–¢–ù–´–ô –ê–ù–ê–õ–ò–ó –°–¢–ê–†–¢–ê–ü–ê\n"
        formatted_result += "=" * 40 + "\n\n"
        formatted_result += result
        
        return formatted_result
        
    except Exception as e:
        raise Exception(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Groq API: {str(e)}")
